<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, width=device-width, viewport-fit=cover, user-scalable=no">
    <meta name="color-scheme" content="light dark">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: blob: https://ssl.gstatic.com 'unsafe-eval' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; media-src * blob:; img-src * data: blob:; connect-src *;">
    <title>Validación Biométrica</title>
    <style>
        /* === ESTILOS ORIGINALES DE ENEXT === */
        
        /* General Body Styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background-color: #ffffff;
            color: #333;
        }

        /* Page Structure */
        .page {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            background-color: #f0f2f5;
        }
        .page.active {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .content {
            text-align: center;
            padding: 20px;
        }

        /* Button Styles */
        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            background-color: #007aff;
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:disabled {
            background-color: #999;
        }
        button:active {
            background-color: #0056b3;
        }

        /* === CAMERA PAGE STYLES === */
        #cameraPage {
            background: #000;
        }

        .branding-bg {
            width: 100%;
            height: 100%;
            /* Gradiente similar al fondo original */
            background: linear-gradient(180deg, #1a237e 0%, #0d47a1 30%, #1565c0 60%, #1976d2 100%);
            background-size: cover;
            background-position: center;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        /* Close Button */
        #closeCameraBtn {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 20;
            background: rgba(0,0,0,0.3);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            color: white;
            cursor: pointer;
        }

        .camera-logo {
            width: 140px;
            margin-bottom: 15px;
        }

        .camera-title {
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.4);
            margin-bottom: 15px;
            margin-top: 0;
        }

        /* Camera Circle */
        .camera-circle {
            position: relative;
            width: min(80vw, 340px);
            height: min(80vw, 340px);
            margin: 0 auto 10px auto;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid #ffd800;
            background-color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .camera-circle::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            background: conic-gradient(transparent 0deg, transparent 0deg);
            z-index: 1;
        }

        .camera-circle.timer-active::before {
            animation: draw-border 3s linear forwards;
        }

        @keyframes draw-border {
            0% {
                background: conic-gradient(orange 0deg, transparent 0deg);
            }
            100% {
                background: conic-gradient(orange 360deg, transparent 0deg);
            }
        }

        .camera-circle video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            z-index: 2;
            position: relative;
            transform: scaleX(-1);
        }

        /* Camera Bottom Container */
        .camera-bottom-container {
            height: 70px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .camera-subtitle {
            color: white;
            font-size: 1rem;
            font-weight: 400;
            text-align: center;
            margin: 0;
        }

        /* Progress Bar */
        #capture-progress-container {
            text-align: center;
            color: white;
            width: 100%;
            display: none;
        }

        #capture-progress-container p {
            font-size: 1rem;
            margin-bottom: 10px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .progress-bar-outline {
            width: 80%;
            max-width: 300px;
            height: 10px;
            border: 1px solid white;
            border-radius: 5px;
            margin: 0 auto;
            overflow: hidden;
        }

        .progress-bar-inner {
            height: 100%;
            width: 0;
            background-color: #3498db;
            border-radius: 5px;
        }

        .progress-bar-inner.animating {
            transition: width 3s linear;
        }

        /* Camera Controls */
        .camera-controls {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }

        #startCaptureBtn {
            width: auto;
            padding: 12px 40px;
            font-size: 1.2rem;
            font-weight: 600;
            border-radius: 30px;
            border: 2px solid #fff;
            background-color: #3498db;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        #startCaptureBtn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        /* Retry Container */
        #retry-container {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
        }

        #retryBtn {
            padding: 12px 28px;
            background: #d35400;
            color: #fff;
            border-radius: 6px;
            border: none;
            width: auto;
        }

        /* Popups */
        .popup {
            display: none;
            position: absolute;
            bottom: 50%;
            left: 50%;
            transform: translate(-50%, 200%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 100;
            text-align: center;
            flex-direction: column;
        }

        .spinner {
            display: none;
            margin: 10px auto 0;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* === RESULT PAGES === */
        .result-page {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            background-color: #f0f2f5;
        }

        .result-page h1 {
            font-size: 1.8rem;
            margin-top: 10px;
            margin-bottom: 5px;
            color: #333;
        }

        .result-page p {
            margin-bottom: 10px;
            color: #666;
        }

        .result-icon {
            font-size: 40px;
            width: 70px;
            height: 70px;
            line-height: 70px;
            margin-bottom: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .result-icon.success {
            background-color: #34c759;
            color: white;
        }

        .result-icon.failure {
            background-color: #ff3b30;
            color: white;
        }

        .go-home-btn {
            margin-top: 20px;
            width: auto;
            padding: 15px 40px;
        }

        /* Token Container */
        .token-container {
            word-wrap: break-word;
            background-color: #f0f0f0;
            border-radius: 8px;
            padding: 10px 15px;
            margin: 10px 0;
            width: 90%;
            max-width: 500px;
            text-align: left;
            color: #333;
        }

        .token-container p {
            margin-top: 0;
            margin-bottom: 5px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .token-container code {
            display: block;
            background-color: #e0e0e0;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.75rem;
            word-break: break-all;
            max-height: 80px;
            overflow-y: auto;
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            width: 90%;
            max-width: 500px;
            margin-top: 15px;
        }

        .button-group button {
            flex: 1;
        }

        .biometric-data {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 5px 12px;
            padding-top: 5px;
            font-size: 0.8rem;
        }

        .biometric-data strong {
            text-transform: capitalize;
            color: #555;
            font-weight: 600;
        }

        .biometric-data span {
            color: #111;
        }

        /* === LOADING PAGE === */
        #loadingPage {
            background: linear-gradient(180deg, #1a237e 0%, #0d47a1 30%, #1565c0 60%, #1976d2 100%);
        }

        #loadingPage .content {
            color: white;
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #ffd800;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
    </style>
</head>
<body>
    <!-- Loading Page -->
    <div id="loadingPage" class="page active">
        <div class="content">
            <div class="loading-spinner"></div>
            <h2>Iniciando...</h2>
            <p id="loadingMessage">Generando token de autorización...</p>
        </div>
    </div>

    <!-- Camera Page -->
    <div id="cameraPage" class="page">
        <div class="branding-bg">
            <button id="closeCameraBtn">←</button>

            <h2 class="camera-title">Valida tu identidad</h2>

            <div class="camera-circle" id="cameraCircle">
                <video id="cameraPreview" autoplay playsinline muted></video>
            </div>

            <div class="camera-bottom-container">
                <p class="camera-subtitle" id="cameraSubtitle">Coloca tu rostro en el círculo</p>

                <div id="capture-progress-container">
                    <p>Capturando rostro...</p>
                    <div class="progress-bar-outline">
                        <div id="capture-progress-bar" class="progress-bar-inner"></div>
                    </div>
                </div>
            </div>

            <div class="camera-controls" id="cameraControls">
                <button id="startCaptureBtn">Validar</button>
            </div>

            <div id="camera-popup" class="popup">
                <p id="camera-popup-message"></p>
                <div class="spinner" id="popupSpinner"></div>
            </div>

            <div id="retry-container">
                <button id="retryBtn">Intentar de Nuevo</button>
            </div>
        </div>
    </div>

    <!-- Success Page -->
    <div id="successPage" class="page">
        <div class="content result-page">
            <div class="result-icon success">✓</div>
            <h1>Validación Exitosa</h1>
            <p>El proceso se completó correctamente.</p>

            <div class="token-container" id="biometricDataContainer" style="display: none;">
                <p>Datos del Ciudadano:</p>
                <div id="biometricDataDisplay" class="biometric-data"></div>
            </div>

            <div class="token-container">
                <p>Access Token:</p>
                <code id="accessTokenDisplay">(Token)</code>
            </div>

            <div class="button-group">
                <button class="go-home-btn" id="successBtn">Continuar</button>
            </div>
        </div>
    </div>

    <!-- Failure Page -->
    <div id="failurePage" class="page">
        <div class="content result-page">
            <div class="result-icon failure">✗</div>
            <h1>Validación Fallida</h1>
            <p id="failureMessage">No se pudo completar la validación.</p>

            <div class="button-group">
                <button class="go-home-btn" id="retryValidationBtn">Reintentar</button>
                <button class="go-home-btn" id="cancelBtn" style="background-color: #ff3b30;">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // === LÓGICA ORIGINAL DE ENEXT ===

        // --- App State ---
        var config = null;
        var validationAttempts = 0;
        var MAX_ATTEMPTS = 3;
        var cameraStream = null;
        var accessToken = null;

        // --- DOM Elements ---
        var pages = {};
        var cameraPage = {};

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, waiting for config...');
            initDOMElements();
            setTimeout(tryGetConfig, 100);
        });

        function onConfigReady() {
            if (window.BIOMETRIA_CONFIG) {
                config = window.BIOMETRIA_CONFIG;
                startProcess();
            }
        }

        function tryGetConfig() {
            if (window.AndroidBiometria) {
                try {
                    var configStr = AndroidBiometria.getConfig();
                    config = JSON.parse(configStr);
                    console.log('Config loaded for cedula:', config.cedula);
                    startProcess();
                    return;
                } catch (e) {
                    console.error('Error getting config:', e);
                }
            }
            if (window.BIOMETRIA_CONFIG) {
                config = window.BIOMETRIA_CONFIG;
                startProcess();
                return;
            }
            setTimeout(tryGetConfig, 200);
        }

        function initDOMElements() {
            pages.loading = document.getElementById('loadingPage');
            pages.camera = document.getElementById('cameraPage');
            pages.success = document.getElementById('successPage');
            pages.failure = document.getElementById('failurePage');

            cameraPage.video = document.getElementById('cameraPreview');
            cameraPage.closeBtn = document.getElementById('closeCameraBtn');
            cameraPage.popup = document.getElementById('camera-popup');
            cameraPage.popupMessage = document.getElementById('camera-popup-message');
            cameraPage.spinner = document.getElementById('popupSpinner');
            cameraPage.retryContainer = document.getElementById('retry-container');
            cameraPage.retryBtn = document.getElementById('retryBtn');
            cameraPage.startCaptureBtn = document.getElementById('startCaptureBtn');
            cameraPage.cameraControls = document.getElementById('cameraControls');
            cameraPage.progressContainer = document.getElementById('capture-progress-container');
            cameraPage.progressBar = document.getElementById('capture-progress-bar');
            cameraPage.subtitle = document.getElementById('cameraSubtitle');
            cameraPage.cameraCircle = document.getElementById('cameraCircle');

            // Event Listeners
            if (cameraPage.closeBtn) cameraPage.closeBtn.addEventListener('click', cancelValidation);
            if (cameraPage.startCaptureBtn) cameraPage.startCaptureBtn.addEventListener('click', runCaptureSequence);
            if (cameraPage.retryBtn) cameraPage.retryBtn.addEventListener('click', runCaptureSequence);

            var successBtn = document.getElementById('successBtn');
            if (successBtn) successBtn.addEventListener('click', completeSuccess);

            var retryValidationBtn = document.getElementById('retryValidationBtn');
            if (retryValidationBtn) retryValidationBtn.addEventListener('click', retryFromFailure);

            var cancelBtn = document.getElementById('cancelBtn');
            if (cancelBtn) cancelBtn.addEventListener('click', cancelValidation);
        }

        // --- Main Process ---
        function startProcess() {
            if (!config) {
                sendError('CONFIG_ERROR', 'No se recibió la configuración');
                return;
            }
            showPage('loading');
            updateLoadingMessage('Generando token de autorización...');
            fetchAuthToken();
        }

        // --- Token Generation ---
        function fetchAuthToken() {
            console.log('Fetching auth token...');
            var credentials = { username: config.username, password: config.password };

            var xhr = new XMLHttpRequest();
            xhr.open('POST', config.tokenEndpoint, true);
            xhr.setRequestHeader('Content-Type', 'application/json');

            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var tokenData = JSON.parse(xhr.responseText);
                            if (tokenData.access_token) {
                                accessToken = tokenData.access_token;
                                console.log('Token obtained successfully');
                                updateLoadingMessage('Iniciando cámara...');
                                setTimeout(startCamera, 500);
                            } else {
                                sendError('TOKEN_ERROR', 'No se recibió un token válido');
                            }
                        } catch (e) {
                            sendError('TOKEN_PARSE_ERROR', 'Respuesta de token no válida');
                        }
                    } else {
                        sendError('TOKEN_REQUEST_ERROR', 'No se pudo obtener el token de autorización');
                    }
                }
            };
            xhr.onerror = function() {
                sendError('TOKEN_NETWORK_ERROR', 'Error de red al obtener el token');
            };
            xhr.send(JSON.stringify(credentials));
        }

        // --- Camera Functions ---
        function startCamera() {
            showPage('camera');
            if (cameraStream) stopCamera();
            console.log('Starting camera...');

            // Initial UI state
            cameraPage.startCaptureBtn.style.display = 'block';
            cameraPage.startCaptureBtn.disabled = false;
            cameraPage.retryContainer.style.display = 'none';
            cameraPage.progressContainer.style.display = 'none';
            cameraPage.subtitle.style.display = 'block';
            cameraPage.cameraControls.style.display = 'flex';
            hideCameraPopup();

            navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } },
                audio: false
            }).then(function(stream) {
                cameraStream = stream;
                cameraPage.video.srcObject = stream;
                console.log('Camera started');
            }).catch(function(err) {
                console.error('Camera error:', err);
                sendError('CAMERA_ERROR', 'No se pudo acceder a la cámara');
            });
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(function(track) { track.stop(); });
                cameraStream = null;
            }
        }

        // --- Capture Sequence ---
        function runCaptureSequence() {
            console.log('Running capture sequence...');

            // Hide buttons and subtitle, show progress bar
            cameraPage.startCaptureBtn.style.display = 'none';
            cameraPage.cameraControls.style.display = 'none';
            cameraPage.retryContainer.style.display = 'none';
            cameraPage.subtitle.style.display = 'none';
            cameraPage.progressContainer.style.display = 'block';

            // Reset progress bar
            cameraPage.progressBar.classList.remove('animating');
            cameraPage.progressBar.style.width = '0%';
            void cameraPage.progressBar.offsetWidth;

            // Animate progress bar
            cameraPage.progressBar.classList.add('animating');
            cameraPage.progressBar.style.width = '100%';

            // Animate circle border
            cameraPage.cameraCircle.classList.remove('timer-active');
            void cameraPage.cameraCircle.offsetWidth;
            cameraPage.cameraCircle.classList.add('timer-active');

            setTimeout(function() {
                cameraPage.progressContainer.style.display = 'none';
                cameraPage.progressBar.classList.remove('animating');
                cameraPage.progressBar.style.width = '0%';
                cameraPage.cameraCircle.classList.remove('timer-active');
                takeAndProcessPhoto();
            }, 3000);
        }

        // --- Photo Capture & Validation ---
        function takeAndProcessPhoto() {
            console.log('Capturing photo...');
            showCameraPopup('Validando foto...', true);

            var video = cameraPage.video;
            if (!video.srcObject) {
                handleApiFailure('La cámara no está activa.');
                return;
            }

            var canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            var ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            var base64PictureData = canvas.toDataURL('image/jpeg', 0.85);

            validationAttempts++;

            var payload = {
                cedula: config.cedula,
                cod_dactilar: config.codDactilar,
                img_base64: base64PictureData.split(',')[1],
                token: accessToken
            };

            console.log('Sending validation. Attempt ' + validationAttempts + '/' + MAX_ATTEMPTS);

            var xhr = new XMLHttpRequest();
            xhr.open('POST', config.biometriaEndpoint, true);
            xhr.setRequestHeader('Content-Type', 'application/json');

            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var result = JSON.parse(xhr.responseText);
                            if (result.status === 'success') {
                                handleBiometricSuccess(result);
                            } else {
                                handleApiFailure(result.message || 'La API devolvió un fallo.');
                            }
                        } catch (e) {
                            handleApiFailure('Respuesta del servidor no válida.');
                        }
                    } else {
                        var errorMessage = 'Error de comunicación con el servidor.';
                        try {
                            var errorResult = JSON.parse(xhr.responseText);
                            if (errorResult && errorResult.message) {
                                errorMessage = errorResult.message;
                            }
                        } catch (e) {}
                        handleApiFailure(errorMessage);
                    }
                }
            };
            xhr.onerror = function() {
                handleApiFailure('Error de Red. Verifique su conexión.');
            };
            xhr.send(JSON.stringify(payload));
        }

        // --- Success Handling ---
        function handleBiometricSuccess(biometricData) {
            console.log('Validation successful');
            stopCamera();

            var biometricDataToStore = biometricData.datos_RC || biometricData;

            document.getElementById('accessTokenDisplay').textContent = accessToken;

            var container = document.getElementById('biometricDataContainer');
            var display = document.getElementById('biometricDataDisplay');

            if (biometricDataToStore && typeof biometricDataToStore === 'object') {
                var html = '';
                for (var key in biometricDataToStore) {
                    if (biometricDataToStore.hasOwnProperty(key)) {
                        var formattedKey = key.replace(/([A-Z])/g, ' $1');
                        formattedKey = formattedKey.charAt(0).toUpperCase() + formattedKey.slice(1);
                        html += '<strong>' + formattedKey + ':</strong> <span>' + biometricDataToStore[key] + '</span>';
                    }
                }
                if (html) {
                    display.innerHTML = html;
                    container.style.display = 'block';
                }
            }

            showPage('success');

            window.validationResult = {
                accessToken: accessToken,
                biometricData: biometricDataToStore,
                timestamp: new Date().toISOString()
            };
        }

        function completeSuccess() {
            if (window.AndroidBiometria && window.validationResult) {
                AndroidBiometria.onSuccess(
                    window.validationResult.accessToken,
                    JSON.stringify(window.validationResult.biometricData),
                    window.validationResult.timestamp
                );
            }
        }

        // --- Failure Handling ---
        function handleApiFailure(message) {
            console.log('Validation failed:', message);
            hideCameraPopup();

            if (validationAttempts >= MAX_ATTEMPTS) {
                stopCamera();
                document.getElementById('failureMessage').textContent = message;
                showPage('failure');
            } else {
                showCameraPopup(message + '\nIntento ' + validationAttempts + '/' + MAX_ATTEMPTS + '.', false);

                setTimeout(function() {
                    hideCameraPopup();
                    cameraPage.retryContainer.style.display = 'flex';
                    cameraPage.startCaptureBtn.style.display = 'none';
                    cameraPage.cameraControls.style.display = 'none';
                    cameraPage.progressContainer.style.display = 'none';
                    cameraPage.subtitle.style.display = 'block';
                }, 4000);
            }
        }

        function retryFromFailure() {
            validationAttempts = 0;
            showPage('loading');
            updateLoadingMessage('Reiniciando...');
            setTimeout(startCamera, 500);
        }

        // --- Cancel / Error ---
        function cancelValidation() {
            stopCamera();
            if (window.AndroidBiometria) AndroidBiometria.onCancel();
        }

        function sendError(code, message) {
            console.error('Error:', code, message);
            stopCamera();
            if (window.AndroidBiometria) AndroidBiometria.onError(code, message);
        }

        // --- UI Helpers ---
        function showPage(pageId) {
            for (var key in pages) {
                if (pages[key]) pages[key].classList.remove('active');
            }
            if (pages[pageId]) pages[pageId].classList.add('active');
        }

        function updateLoadingMessage(message) {
            var el = document.getElementById('loadingMessage');
            if (el) el.textContent = message;
        }

        function showCameraPopup(message, showSpinner) {
            cameraPage.popupMessage.textContent = message;
            cameraPage.spinner.style.display = showSpinner ? 'block' : 'none';
            cameraPage.popup.style.display = 'flex';
        }

        function hideCameraPopup() {
            if (cameraPage.popup) cameraPage.popup.style.display = 'none';
        }
    </script>
</body>
</html>
